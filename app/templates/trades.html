{% extends "base.html" %}

{% block title %}Croc Trader â€“ Trades{% endblock %}

{% block extra_head %}
<style>
    /* ... existing global styles ... */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* ... header and stats grid styles remain the same ... */
    .page-header { margin-bottom: 25px; }
    .page-header h1 { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    .page-header p { color: #6B7280; margin-top: 5px; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        border: 1px solid #E5E7EB;
    }
    .stat-icon {
        width: 40px; height: 40px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        margin-right: 15px; flex-shrink: 0;
    }
    .stat-icon svg { width: 24px; height: 24px; color: white; }
    .stat-content dt { font-size: 13px; color: #6B7280; font-weight: 500; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-content dd { font-size: 24px; font-weight: 700; color: #111827; margin: 0; line-height: 1.2; }

    /* --- UPDATED FILTERS CSS --- */
    .filters-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 25px;
        border: 1px solid #E5E7EB;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end; /* Aligns bottom of all items */
    }
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    .filter-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
        line-height: 1.2;
    }
    /* Harmonized Input/Select/Button Styles */
    .filter-control, .filter-btn {
        width: 100%;
        height: 38px; /* Fixed height for all */
        padding: 0 12px; /* Consistent padding */
        border: 1px solid #D1D5DB;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        vertical-align: middle;
    }
    .filter-control {
        background-color: #fff;
    }
    .filter-btn {
        background-color: #F3F4F6;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.15s;
    }
    .filter-btn:hover {
        background-color: #E5E7EB;
        border-color: #9CA3AF;
    }

    /* ... table and badge styles remain the same ... */
    .table-container { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #E5E7EB; overflow-x: auto; }
    .trades-table { min-width: 100%; border-collapse: collapse; }
    .trades-table th { background: #F9FAFB; padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #E5E7EB; }
    .trades-table th.text-right { text-align: right; }
    .trades-table td { padding: 14px 16px; font-size: 14px; color: #374151; border-bottom: 1px solid #E5E7EB; white-space: nowrap; }
    .trades-table tr:hover { background-color: #F9FAFB; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-win { background: #DCFCE7; color: #166534; }
    .badge-loss { background: #FEE2E2; color: #991B1B; }
    .badge-active { background: #FEF3C7; color: #92400E; }
    .badge-pending { background: #F3F4F6; color: #374151; }
    .badge-rejected { background: #E5E7EB; color: #4B5563; }
    .text-green { color: #16A34A; }
    .text-red { color: #DC2626; }
    .text-gray { color: #9CA3AF; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

  <!-- Header -->
  <div class="page-header">
    <h1>Tracked Trades</h1>
    <p>Overview of all signals marked for tracking and their current performance.</p>
  </div>

  <!-- Summary Tiles -->
  <div class="stats-grid">
    <!-- Total Trades -->
    <div class="stat-card">
      <div class="stat-icon" style="background-color: #3B82F6;">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
      </div>
      <div class="stat-content">
        <dt>Total Trades</dt>
        <dd id="count-total">0</dd>
      </div>
    </div>

    <!-- Pending -->
    <div class="stat-card">
      <div class="stat-icon" style="background-color: #9CA3AF;">
         <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      </div>
      <div class="stat-content">
        <dt>Pending</dt>
        <dd id="count-pending">0</dd>
      </div>
    </div>

    <!-- Active -->
    <div class="stat-card">
      <div class="stat-icon" style="background-color: #F59E0B;">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
      </div>
      <div class="stat-content">
        <dt>Active</dt>
        <dd id="count-active">0</dd>
      </div>
    </div>

    <!-- Win -->
    <div class="stat-card">
      <div class="stat-icon" style="background-color: #10B981;">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      </div>
      <div class="stat-content">
        <dt>Win</dt>
        <dd id="count-win">0</dd>
      </div>
    </div>

    <!-- Loss -->
    <div class="stat-card">
      <div class="stat-icon" style="background-color: #EF4444;">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      </div>
      <div class="stat-content">
        <dt>Loss</dt>
        <dd id="count-loss">0</dd>
      </div>
    </div>

    <!-- Rejected -->
    <div class="stat-card">
      <div class="stat-icon" style="background-color: #6B7280;">
         <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
      </div>
      <div class="stat-content">
        <dt>Rejected</dt>
        <dd id="count-rejected">0</dd>
      </div>
    </div>
  </div>


  <!-- Filters -->
  <div class="filters-box">

    <div class="filter-group">
      <label for="filter-symbol">Symbol</label>
      <input type="text" id="filter-symbol" list="symbol-list" placeholder="e.g. AAPL" class="filter-control">
      <datalist id="symbol-list">
        <!-- Populated by JS -->
      </datalist>
    </div>

    <div class="filter-group">
      <label for="filter-signal">Signal Type</label>
      <select id="filter-signal" class="filter-control">
        <option value="">All Signals</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-state">State</label>
      <select id="filter-state" class="filter-control">
        <option value="">All States</option>
        <option value="pending">Pending</option>
        <option value="active">Active</option>
        <option value="win">Win</option>
        <option value="loss">Loss</option>
        <option value="rejected">Rejected</option>
        <option value="closed">Closed</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-date">Signal Date</label>
      <input type="date" id="filter-date" class="filter-control">
    </div>

    <div class="filter-group">
      <!-- Invisible label to force alignment -->
      <label>&nbsp;</label>
      <button id="reset-filters" class="filter-btn">
        Reset Filters
      </button>
    </div>
  </div>



  <!-- Table -->
  <div class="table-container">
    <table class="trades-table" id="trades-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>TF</th>
          <th>Signal</th>
          <th>Signal Time</th>
          <th>State</th>
          <th class="text-right">Qty</th>
          <th class="text-right">Buy Limit</th>
          <th class="text-right">Stop</th>
          <th class="text-right">TP</th>
          <th>Entry Time</th>
          <th class="text-right">Entry</th>
          <th>Exit Time</th>
          <th class="text-right">Exit</th>
          <th class="text-right">P/L ($)</th>
        </tr>
      </thead>
      <tbody id="trades-body">
        {% for t in trades %}
        <tr class="trade-row"
            data-symbol="{{ t.symbol|upper }}"
            data-signal="{{ t.signal }}"
            data-state="{{ t.state }}"
            data-date="{{ t.signal_timestamp }}">

          <td style="font-weight: 500;">{{ t.symbol }}</td>
          <td>{{ t.signal_timeframe or '-' }}</td>
          <td>{{ t.signal }}</td>

          <td>
              {% if t.signal_timestamp %}
                {{ t.signal_timestamp.split('T')[0] }}
              {% else %}
                -
              {% endif %}
          </td>

          <td>
            {% if t.state == 'win' %}
              <span class="badge badge-win">WIN</span>
            {% elif t.state == 'loss' %}
              <span class="badge badge-loss">LOSS</span>
            {% elif t.state == 'active' %}
              <span class="badge badge-active">ACTIVE</span>
            {% elif t.state == 'pending' %}
              <span class="badge badge-pending">PENDING</span>
            {% elif t.state == 'rejected' %}
              <span class="badge badge-rejected">REJECTED</span>
            {% else %}
               <span class="badge badge-pending">{{ t.state|upper if t.state else '-' }}</span>
            {% endif %}
          </td>

          <td class="text-right">{{ t.quantity if t.quantity else '-' }}</td>
          <td class="text-right">{{ "%.2f"|format(t.buy_limit) if t.buy_limit else '-' }}</td>
          <td class="text-right">{{ "%.2f"|format(t.stop_loss) if t.stop_loss else '-' }}</td>
          <td class="text-right">{{ "%.2f"|format(t.take_profit) if t.take_profit else '-' }}</td>

          <td>{{ t.entry_time or '-' }}</td>
          <td class="text-right">{{ "%.2f"|format(t.entry_price) if t.entry_price else '-' }}</td>

          <td>{{ t.exit_time or '-' }}</td>
          <td class="text-right">
             {% if t.exit_price %}
               {{ "%.2f"|format(t.exit_price) }}
             {% elif t.current_price and t.state == 'active' %}
               <span class="text-gray" style="font-size: 11px;">cur:</span> {{ "%.2f"|format(t.current_price) }}
             {% else %}
               -
             {% endif %}
          </td>

          <td class="text-right" style="font-weight: 600;">
              {% if t.profit_loss %}
                 <span class="{{ 'text-green' if t.profit_loss > 0 else 'text-red' }}">
                   {{ "%.2f"|format(t.profit_loss) }}
                 </span>
              {% elif t.state == 'active' and t.entry_price and t.current_price and t.quantity %}
                 {% set upl = (t.current_price - t.entry_price) * t.quantity %}
                 <span class="{{ 'text-green' if upl > 0 else 'text-red' }}">
                   (~{{ "%.2f"|format(upl) }})
                 </span>
              {% else %}
                 -
              {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="14" style="text-align: center; padding: 30px; color: #9CA3AF;">No trades tracked yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rows = Array.from(document.querySelectorAll('.trade-row'));
    const filterSymbol = document.getElementById('filter-symbol');
    const symbolList = document.getElementById('symbol-list');
    const filterSignal = document.getElementById('filter-signal');
    const filterState = document.getElementById('filter-state');
    const filterDate = document.getElementById('filter-date');
    const btnReset = document.getElementById('reset-filters');

    // 1. Initialize Dropdowns & Datalists from data
    const uniqueSignals = new Set();
    const uniqueSymbols = new Set();

    rows.forEach(r => {
        if(r.dataset.signal) uniqueSignals.add(r.dataset.signal);
        if(r.dataset.symbol) uniqueSymbols.add(r.dataset.symbol);
    });

    // Populate Signal Select
    Array.from(uniqueSignals).sort().forEach(sig => {
        const opt = document.createElement('option');
        opt.value = sig;
        opt.textContent = sig;
        filterSignal.appendChild(opt);
    });

    // Populate Symbol Datalist
    Array.from(uniqueSymbols).sort().forEach(sym => {
        const opt = document.createElement('option');
        opt.value = sym;
        symbolList.appendChild(opt);
    });

    function updateStats(visibleRows) {
        let stats = {
            total: 0, pending: 0, active: 0,
            win: 0, loss: 0, rejected: 0
        };

        visibleRows.forEach(row => {
            stats.total++;
            let state = (row.dataset.state || '').toLowerCase();
            if (stats.hasOwnProperty(state)) {
                stats[state]++;
            }
        });

        document.getElementById('count-total').textContent = stats.total;
        document.getElementById('count-pending').textContent = stats.pending;
        document.getElementById('count-active').textContent = stats.active;
        document.getElementById('count-win').textContent = stats.win;
        document.getElementById('count-loss').textContent = stats.loss;
        document.getElementById('count-rejected').textContent = stats.rejected;
    }

    function filterTable() {
        const sVal = filterSymbol.value.toUpperCase();
        const sigVal = filterSignal.value;
        const stateVal = filterState.value;
        const dateVal = filterDate.value; // YYYY-MM-DD format from input[type=date]

        const visibleRows = rows.filter(row => {
            const rSymbol = row.dataset.symbol || '';
            const rSignal = row.dataset.signal || '';
            const rState = row.dataset.state || '';
            const rDateFull = row.dataset.date || '';
            const rDate = rDateFull.split('T')[0]; // Extract YYYY-MM-DD

            // Filter Logic
            if (sVal && !rSymbol.includes(sVal)) return false;
            if (sigVal && rSignal !== sigVal) return false;
            if (stateVal && rState !== stateVal) return false;
            if (dateVal && rDate !== dateVal) return false;

            return true;
        });

        // Toggle Visibility
        rows.forEach(row => {
            row.style.display = visibleRows.includes(row) ? '' : 'none';
        });

        updateStats(visibleRows);
    }

    // Event Listeners
    filterSymbol.addEventListener('input', filterTable); // input event for real-time typing
    filterSignal.addEventListener('change', filterTable);
    filterState.addEventListener('change', filterTable);
    filterDate.addEventListener('change', filterTable); // Native date picker triggers change

    btnReset.addEventListener('click', () => {
        filterSymbol.value = '';
        filterSignal.value = '';
        filterState.value = '';
        filterDate.value = '';
        filterTable();
    });

    // Initial Run
    updateStats(rows);
});
</script>

{% endblock %}
